{{define "title"}} — {{.Project.Title}}{{end}}

{{define "og_meta"}}
<meta property="og:title" content="{{.Project.Title}} — Svyaz">
<meta property="og:description" content="{{ogClean .Project.Description 200}}">
<meta property="og:type" content="article">
<meta property="og:url" content="https://svyaz.fitra.tech/project/{{.Project.Slug}}">
<meta property="og:image" content="https://svyaz.fitra.tech/project/{{.Project.Slug}}/og.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:site_name" content="Svyaz">
<meta name="twitter:card" content="summary_large_image">
{{end}}

{{define "content"}}
<div class="project-page">
    <a href="/" class="back-link"><i data-lucide="arrow-left" class="icon-sm"></i> Назад</a>

    {{if .JustCreated}}
    <div class="moderation-notice">
        <i data-lucide="clock" class="icon"></i>
        Проект отправлен на модерацию. Он появится в общей ленте после проверки.
    </div>
    {{end}}

    {{if and .IsAuthor (ne .Project.Status "active") (not .JustCreated)}}
    <div class="moderation-notice moderation-notice--{{.Project.Status}}">
        <i data-lucide="{{if eq .Project.Status "pending"}}clock{{else}}eye-off{{end}}" class="icon"></i>
        {{if eq .Project.Status "pending"}}Проект на модерации{{end}}
        {{if eq .Project.Status "hidden"}}Проект скрыт модератором{{end}}
    </div>
    {{end}}

    <div class="project-header">
        <h1 class="project-title">{{.Project.Title}}</h1>
        {{if .IsAuthor}}
        <div class="project-actions">
            <a href="/project/{{.Project.Slug}}/edit" class="btn btn-secondary btn-sm">
                <i data-lucide="edit" class="icon-sm"></i> Редактировать
            </a>
            <form action="/api/projects/{{.Project.Slug}}/delete" method="POST" onsubmit="return confirm('Удалить проект?')">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <button type="submit" class="btn btn-danger btn-sm">
                    <i data-lucide="trash" class="icon-sm"></i> Удалить
                </button>
            </form>
        </div>
        {{end}}
    </div>

    <div class="project-meta">
        <span class="meta-item">
            <i data-lucide="calendar" class="icon-sm"></i> {{formatDate .Project.CreatedAt}}
        </span>
        <a href="/user/{{.Project.Author.ID}}" class="meta-item meta-author">
            {{if .Project.Author.PhotoURL}}<img src="{{.Project.Author.PhotoURL}}" alt="" class="author-avatar-sm">{{else}}<span class="author-avatar-sm">{{slice .Project.Author.Name 0 1}}</span>{{end}}
            {{.Project.Author.Name}}
        </a>
        {{if .Project.Author.TgUsername}}
        <a href="https://t.me/{{.Project.Author.TgUsername}}" target="_blank" class="meta-item meta-tg">
            <i data-lucide="at-sign" class="icon-sm"></i> {{.Project.Author.TgUsername}}
        </a>
        {{end}}
    </div>

    <div class="project-body">
        <p>{{.Project.Description}}</p>
    </div>

    {{if .Project.Stack}}
    <div class="project-section">
        <h3 class="section-label"><i data-lucide="code" class="icon-sm"></i> Стек</h3>
        <div class="tag-list">
            {{range .Project.Stack}}
            <a href="/?stack={{.}}" class="tag tag-stack">{{.}}</a>
            {{end}}
        </div>
    </div>
    {{end}}

    {{if .Project.Roles}}
    <div class="project-section">
        <h3 class="section-label"><i data-lucide="users" class="icon-sm"></i> Ищем в команду</h3>
        <div class="tag-list">
            {{range .Project.Roles}}
            <span class="badge badge-{{.Slug}} badge-lg{{if ge .Filled .Count}} badge-filled{{end}}">{{if ge .Filled .Count}}<i data-lucide="check" class="icon-sm"></i> {{end}}{{.Name}}{{if gt .Count 1}} <span class="role-progress">{{.Filled}}/{{.Count}}</span>{{else if and (eq .Count 1) (ge .Filled 1)}}{{else if and (gt .Filled 0) (eq .Count 1)}}{{end}}</span>
            {{end}}
        </div>
    </div>
    {{end}}

    {{if .User}}
        {{if not .IsAuthor}}
        <div class="respond-section">
            {{if .HasResponded}}
                {{if eq .UserResponseStatus "pending"}}
                <div class="responded-notice">
                    <i data-lucide="check-circle" class="icon"></i>
                    <div>
                        <div>Вы откликнулись на этот проект</div>
                        <div class="responded-hint">Если автор примет отклик, он свяжется с вами в Telegram</div>
                    </div>
                </div>
                <form action="/api/projects/{{.Project.Slug}}/cancel-response" method="POST" class="cancel-response-form">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit" class="btn btn-secondary btn-sm">
                        <i data-lucide="x" class="icon-sm"></i> Отменить отклик
                    </button>
                </form>
                {{else if eq .UserResponseStatus "accepted"}}
                <div class="responded-notice">
                    <i data-lucide="check-circle" class="icon"></i>
                    Ваш отклик принят! Автор свяжется с вами в Telegram
                </div>
                {{else}}
                <div class="responded-notice responded-notice--rejected">
                    <i data-lucide="x-circle" class="icon"></i>
                    Ваш отклик отклонён
                </div>
                {{end}}
            {{else}}
            <form action="/api/projects/{{.Project.Slug}}/respond" method="POST">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                {{if .Project.Roles}}
                <div class="role-picker" id="rolePicker">
                    <p class="role-picker-label">Выберите роль:</p>
                    <div class="role-picker-list">
                        {{range .Project.Roles}}
                        <label class="role-picker-item role-picker-{{.Slug}}{{if ge .Filled .Count}} role-picker-disabled{{end}}"{{if ge .Filled .Count}} aria-disabled="true"{{end}}>
                            <input type="radio" name="role_id" value="{{.ID}}"{{if ge .Filled .Count}} disabled{{end}}>
                            <span class="role-picker-name">{{.Name}}</span>
                            {{if gt .Count 1}}<span class="role-progress">{{.Filled}}/{{.Count}}</span>{{end}}
                            {{if ge .Filled .Count}}<i data-lucide="check" class="icon-sm"></i>{{end}}
                        </label>
                        {{end}}
                    </div>
                </div>
                {{end}}
                <button type="submit" class="btn btn-primary btn-lg">
                    <i data-lucide="send" class="icon-sm"></i> Откликнуться
                </button>
                <p class="respond-hint">Автор проекта свяжется с вами в Telegram, если примет отклик</p>
            </form>
            {{end}}
        </div>
        {{end}}
    {{end}}

    {{if .Responses}}
    <div class="responses-section">
        <h3 class="section-label"><i data-lucide="inbox" class="icon-sm"></i> Отклики ({{len .Responses}})</h3>
        <div class="responses-list">
            {{range .Responses}}
            <div class="response-card response-{{.Status}}">
                <a href="/user/{{.User.ID}}" class="response-user">
                    {{if .User.PhotoURL}}<img src="{{.User.PhotoURL}}" alt="" class="author-avatar-sm">{{else}}<span class="author-avatar-sm">{{slice .User.Name 0 1}}</span>{{end}}
                    <div class="response-user-info">
                        <div class="response-name">
                            {{.User.Name}}
                            {{if .Role}}<span class="badge badge-{{.Role.Slug}} badge-sm response-role">{{.Role.Name}}</span>{{end}}
                        </div>
                        <div class="response-details">
                            {{range .User.Roles}}
                            <span class="badge badge-{{.Slug}} badge-sm">{{.Name}}</span>
                            {{end}}
                            {{if .User.Experience}}<span class="response-exp">{{.User.Experience}}</span>{{end}}
                        </div>
                    </div>
                </a>
                <div class="response-right">
                    {{if .User.TgUsername}}
                    <a href="https://t.me/{{.User.TgUsername}}" target="_blank" class="tg-link">
                        <i data-lucide="at-sign" class="icon-sm"></i> {{.User.TgUsername}}
                    </a>
                    {{end}}
                    <div class="response-actions">
                        <span class="status-badge status-{{.Status}}">{{statusText .Status}}</span>
                        {{if eq .Status "pending"}}
                        <form action="/api/responses/{{.ID}}" method="POST" class="inline-form">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <input type="hidden" name="status" value="accepted">
                            <button type="submit" class="btn btn-accept btn-sm">
                                <i data-lucide="check" class="icon-sm"></i> Принять
                            </button>
                        </form>
                        <form action="/api/responses/{{.ID}}" method="POST" class="inline-form">
                            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                            <input type="hidden" name="status" value="rejected">
                            <button type="submit" class="btn btn-reject btn-sm">
                                <i data-lucide="x" class="icon-sm"></i> Отклонить
                            </button>
                        </form>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
</div>
{{end}}
